{% extends "base.html" %}

{% block title %}{{ article.title }}{% endblock %}

{% block head %}
<style>
    .word-highlight {
        background-color: #fef3c7;
        cursor: pointer;
        padding: 0 2px;
        border-radius: 2px;
    }
    .word-highlight:hover {
        background-color: #fde68a;
    }
    .word-highlight.selected {
        background-color: #fbbf24;
    }
    .word-tooltip {
        position: fixed;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 4px;
        padding: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 1000;
        display: none;
    }
    .word-tooltip button {
        margin: 4px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
    }
    .word-tooltip button.add {
        background-color: #3b82f6;
        color: white;
    }
    .word-tooltip button.cancel {
        background-color: #e5e7eb;
        color: #374151;
    }
    .article-content {
        font-size: 18px;
        line-height: 1.8;
        color: #1f2937;
    }
    .article-content p {
        margin-bottom: 1.5em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- 返回按钮 -->
        <a href="/" class="inline-block mb-6 text-blue-600 hover:text-blue-800">
            <i class="fas fa-arrow-left mr-2"></i>返回列表
        </a>
        
        <!-- 文章标题和链接 -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-4">{{ article.title }}</h1>
            <a href="{{ article.url }}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-external-link-alt mr-1"></i>{{ article.url }}
            </a>
        </div>

        <!-- 文章内容 -->
        <div class="article-content" id="article-content">
            {% for paragraph in article.paragraphs %}
            <p>{{ paragraph }}</p>
            {% endfor %}
        </div>
    </div>
</div>

<div id="word-tooltip" class="word-tooltip">
    <div class="font-medium mb-2" id="tooltip-word"></div>
    <div class="flex space-x-2">
        <button class="add" onclick="addToVocabulary()">添加到生词本</button>
        <button class="cancel" onclick="hideTooltip()">取消</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedWord = '';
    let tooltip = document.getElementById('word-tooltip');
    let articleContent = document.getElementById('article-content');

    // 处理双击事件
    articleContent.addEventListener('dblclick', function(e) {
        const selection = window.getSelection();
        const word = selection.toString().trim();
        
        if (word && /^[a-zA-Z]+$/.test(word)) {
            selectedWord = word;
            showTooltip(e.pageX, e.pageY);
        }
    });

    // 显示工具提示
    window.showTooltip = function(x, y) {
        tooltip.style.display = 'block';
        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
        document.getElementById('tooltip-word').textContent = selectedWord;
    };

    // 隐藏工具提示
    window.hideTooltip = function() {
        tooltip.style.display = 'none';
        selectedWord = '';
    };

    // 添加到生词本
    window.addToVocabulary = async function() {
        try {
            const response = await fetch('/api/vocabulary', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    word: selectedWord,
                    source_url: window.location.href
                })
            });

            const data = await response.json();
            
            if (data.success) {
                alert('已添加到生词本！');
            } else {
                alert('添加失败：' + data.error);
            }
        } catch (error) {
            console.error('添加生词失败:', error);
            alert('添加失败，请重试');
        }
        
        hideTooltip();
    };

    // 点击其他地方时隐藏工具提示
    document.addEventListener('click', function(e) {
        if (!tooltip.contains(e.target)) {
            hideTooltip();
        }
    });
});
</script>
{% endblock %}